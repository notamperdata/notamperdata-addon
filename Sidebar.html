<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoTamperData</title>
    <style>
      body {
        font-family: 'Google Sans', Arial, sans-serif;
        margin: 0;
        padding: 16px;
        background-color: #fafafa;
        font-size: 14px;
        line-height: 1.4;
      }
      .container {
        max-width: 400px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        margin-bottom: 24px;
        padding: 16px;
        background: linear-gradient(135deg, #1a73e8 0%, #34a853 100%);
        color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .header h1 {
        margin: 0 0 4px 0;
        font-size: 24px;
        font-weight: 500;
      }
      .header small {
        opacity: 0.9;
        font-size: 13px;
      }
      .section {
        background: white;
        border: 1px solid #dadce0;
        border-radius: 8px;
        margin-bottom: 16px;
        overflow: hidden;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      }
      .section-title {
        background-color: #f8f9fa;
        padding: 12px 16px;
        font-weight: 500;
        color: #3c4043;
        border-bottom: 1px solid #dadce0;
        font-size: 14px;
      }
      .section-content {
        padding: 16px;
      }
      .config-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        gap: 8px;
      }
      .config-row label {
        min-width: 80px;
        font-weight: 500;
        color: #5f6368;
      }
      .config-row input, .config-row select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 14px;
      }
      .config-row input:focus, .config-row select:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 1px #1a73e8;
      }
      .btn {
        background-color: #1a73e8;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        margin-right: 8px;
        margin-bottom: 8px;
        transition: background-color 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .btn:hover {
        background-color: #1557b0;
      }
      .btn:disabled {
        background-color: #dadce0;
        color: #9aa0a6;
        cursor: not-allowed;
      }
      .btn.secondary-btn {
        background-color: #f8f9fa;
        color: #3c4043;
        border: 1px solid #dadce0;
      }
      .btn.secondary-btn:hover {
        background-color: #f1f3f4;
      }
      .btn.danger-btn {
        background-color: #d93025;
      }
      .btn.danger-btn:hover {
        background-color: #b52d20;
      }
      .btn.small-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
      .message {
        padding: 12px;
        border-radius: 4px;
        margin: 8px 0;
        font-size: 13px;
        line-height: 1.4;
      }
      .message.success {
        background-color: #e8f5e8;
        color: #137333;
        border: 1px solid #ceead6;
      }
      .message.error {
        background-color: #fce8e6;
        color: #d93025;
        border: 1px solid #f9dedc;
      }
      .message.info {
        background-color: #e8f0fe;
        color: #1967d2;
        border: 1px solid #d2e3fc;
      }
      .message.warning {
        background-color: #fef7e0;
        color: #b06000;
        border: 1px solid #feeaa7;
      }
      .hidden {
        display: none !important;
      }
      .help-text {
        font-size: 12px;
        color: #5f6368;
        margin: 8px 0 0 0;
        line-height: 1.3;
      }
      .loading {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #1a73e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 6px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .collapsible {
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        margin: 8px 0;
      }
      .collapsible-header {
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .collapsible-content {
        padding: 12px;
        border-top: 1px solid #e0e0e0;
        display: none;
      }
      .collapsible.open .collapsible-content {
        display: block;
      }
      .chevron {
        transition: transform 0.2s;
      }
      .collapsible.open .chevron {
        transform: rotate(180deg);
      }
      
      /* Access Token Display Styles */
      .access-token-display {
        background-color: #f8f9fa;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 12px;
        margin: 8px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .access-token-masked {
        font-family: 'Courier New', monospace;
        font-size: 13px;
        color: #3c4043;
        background-color: white;
        padding: 6px 8px;
        border-radius: 3px;
        border: 1px solid #e0e0e0;
        flex: 1;
        min-width: 0;
      }
      .access-token-actions {
        display: flex;
        gap: 4px;
        flex-shrink: 0;
      }
      .icon-btn {
        background: none;
        border: 1px solid #dadce0;
        border-radius: 3px;
        width: 28px;
        height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
        color: #5f6368;
      }
      .icon-btn:hover {
        background-color: #f1f3f4;
        color: #3c4043;
      }
      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }
      .status-indicator.connected {
        background-color: #137333;
      }
      .status-indicator.disconnected {
        background-color: #d93025;
      }
      .status-indicator.unknown {
        background-color: #f9ab00;
      }

      /* Hash link styles */
      .hash-link {
        color: #1a73e8;
        cursor: pointer;
        text-decoration: underline;
        word-break: break-all;
        font-family: 'Courier New', monospace;
        font-size: 11px;
      }
      .hash-link:hover {
        color: #1557b0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>NoTamperData</h1>
        <small>Batch Blockchain Verification</small>
      </div>
      
      <div id="status-message" class="message hidden"></div>
      
      <div class="section">
        <div class="section-title">Current Form</div>
        <div class="section-content">
          <div id="form-info">
            <span class="loading"></span>Loading...
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Processing Status</div>
        <div class="section-content">
          <div id="processing-status">
            <span class="loading"></span>Loading status...
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <span class="status-indicator unknown" id="token-status-indicator"></span>
          API Configuration
        </div>
        <div class="section-content">
          <!-- Saved Access Token Display -->
          <div id="saved-token-display" class="access-token-display hidden">
            <div class="access-token-masked" id="masked-token">ak_••••••••••••••••</div>
            <div class="access-token-actions">
              <button class="icon-btn" id="edit-token-btn" title="Edit Access Token">
                ✎
              </button>
              <button class="icon-btn" id="remove-token-btn" title="Remove Access Token">
                ×
              </button>
            </div>
          </div>
          
          <!-- Access Token Input (hidden when token is saved) -->
          <div id="token-input-section">
            <div class="config-row">
              <label>Access Token:</label>
              <input type="password" id="access-token-input" placeholder="Enter your access token" style="flex: 1;">
            </div>
            <div style="margin-top: 8px;">
              <button class="btn small-btn" id="saveaccessTokenBtn">Save Access Token</button>
              <button class="btn secondary-btn small-btn" id="testApiBtn">Test Connection</button>
            </div>
          </div>
          
          <div id="api-test-result" class="message info hidden"></div>
          <p class="help-text">Required for blockchain verification services.</p>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Batch Processing</div>
        <div class="section-content">
          <div class="config-row">
            <label>Frequency:</label>
            <select id="frequency-select">
              <option value="manual">Manual Only</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="interval">Every X Hours</option>
            </select>
          </div>
          
          <div class="config-row" id="interval-row" style="display: none;">
            <label>Interval:</label>
            <input type="number" id="interval-input" min="1" max="168" value="24" placeholder="Hours">
          </div>
          
          <div class="config-row" id="day-row" style="display: none;">
            <label>Day:</label>
            <select id="day-select">
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
              <option value="0">Sunday</option>
            </select>
          </div>
          
          <div class="config-row" id="time-row" style="display: none;">
            <label>Time:</label>
            <input type="time" id="time-input" value="11:00">
          </div>
          
          <div style="margin-top: 12px;">
            <button class="btn small-btn" id="saveConfigBtn">Save Configuration</button>
            <button class="btn danger-btn small-btn" id="disableBtn">Disable Processing</button>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Manual Processing</div>
        <div class="section-content">
          <div id="process-result" class="message info hidden"></div>
          <button class="btn" id="processResponsesBtn">Process Responses</button>
          <p class="help-text">Manually process all form responses and generate blockchain hashes.</p>
        </div>
      </div>
      
    </div>

    <script>
      // Initialize when page loads
      document.addEventListener('DOMContentLoaded', function() {
        loadFormInfo();
        loadProcessingStatus();
        loadSavedAccessToken(); // New function to load and display saved token
        updateConfigVisibility();
      });
      
      // Helper function to mask access token for display
      function maskAccessToken(token) {
        if (!token || token.length < 6) return 'ak_••••••••••••••••';
        return token.substring(0, 3) + '••••••••••••' + token.substring(token.length - 2);
      }
      
      // Load and display saved access token
      function loadSavedAccessToken() {
        google.script.run
          .withSuccessHandler(function(token) {
            const savedDisplay = document.getElementById('saved-token-display');
            const inputSection = document.getElementById('token-input-section');
            const maskedToken = document.getElementById('masked-token');
            const statusIndicator = document.getElementById('token-status-indicator');
            
            if (token && token.trim() !== '') {
              // Show masked token display, hide input section
              maskedToken.textContent = maskAccessToken(token);
              savedDisplay.classList.remove('hidden');
              inputSection.classList.add('hidden');
              statusIndicator.className = 'status-indicator connected';
              
              // Test the connection automatically to update status
              testConnectionSilently();
            } else {
              // Show input section, hide token display
              savedDisplay.classList.add('hidden');
              inputSection.classList.remove('hidden');
              statusIndicator.className = 'status-indicator disconnected';
            }
          })
          .withFailureHandler(function(error) {
            console.error('Error loading saved access token:', error);
            // Show input section by default
            document.getElementById('saved-token-display').classList.add('hidden');
            document.getElementById('token-input-section').classList.remove('hidden');
            document.getElementById('token-status-indicator').className = 'status-indicator disconnected';
          })
          .getaccessToken();
      }
      
      // Silent connection test (doesn't show UI messages)
      function testConnectionSilently() {
        google.script.run
          .withSuccessHandler(function(result) {
            const statusIndicator = document.getElementById('token-status-indicator');
            statusIndicator.className = result.success ? 'status-indicator connected' : 'status-indicator disconnected';
          })
          .withFailureHandler(function(error) {
            document.getElementById('token-status-indicator').className = 'status-indicator disconnected';
          })
          .testApiConnection();
      }
      
      // Edit token button handler
      document.getElementById('edit-token-btn').addEventListener('click', function() {
        google.script.run
          .withSuccessHandler(function(token) {
            const savedDisplay = document.getElementById('saved-token-display');
            const inputSection = document.getElementById('token-input-section');
            const input = document.getElementById('access-token-input');
            
            // Switch to edit mode
            savedDisplay.classList.add('hidden');
            inputSection.classList.remove('hidden');
            input.value = token || '';
            input.focus();
          })
          .getaccessToken();
      });
      
      // Remove token button handler
      document.getElementById('remove-token-btn').addEventListener('click', function() {
        if (confirm('Are you sure you want to remove the saved access token?')) {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showMessage('Access token removed successfully', 'success');
                loadSavedAccessToken(); // Refresh display
              } else {
                showMessage('Failed to remove access token', 'error');
              }
            })
            .withFailureHandler(function(error) {
              showMessage('Error removing access token: ' + error, 'error');
            })
            .removeaccessToken(); // We'll need to add this function to Code.js
        }
      });
      
      // Load form information
      function loadFormInfo() {
        google.script.run
          .withSuccessHandler(function(info) {
            const container = document.getElementById('form-info');
            
            if (info.error) {
              container.innerHTML = '<div class="message error">' + info.error + '</div>';
              return;
            }
            
            container.innerHTML = `
              <div style="margin-bottom: 12px;">
                <strong>${info.title}</strong>
                <div style="font-size: 12px; color: #5f6368; margin-top: 2px;">
                  ${info.totalResponses} responses • ID: ${info.id.substring(0, 8)}...
                </div>
              </div>
              <div style="font-size: 13px; color: #3c4043;">
                ${info.description}
              </div>
            `;
          })
          .withFailureHandler(function(error) {
            document.getElementById('form-info').innerHTML = 
              '<div class="message error">Error loading form info: ' + error + '</div>';
          })
          .getFormInfo();
      }
      
      // Load processing status
      function loadProcessingStatus() {
        google.script.run
          .withSuccessHandler(function(status) {
            const container = document.getElementById('processing-status');
            
            if (status.error) {
              container.innerHTML = '<div class="message error">' + status.error + '</div>';
              return;
            }
            
            let statusHtml = '';
            
            if (status.config.enabled) {
              statusHtml += `
                <div class="message success">
                  <strong>✓ Automatic Processing Enabled</strong><br>
                  Frequency: ${status.config.frequency}
                  ${status.config.time ? ` at ${status.config.time}` : ''}
                  ${status.config.interval ? ` every ${status.config.interval} hours` : ''}
                  ${status.config.day ? ` on ${getDayName(status.config.day)}` : ''}
                </div>
              `;
            } else {
              statusHtml += '<div class="message info">Manual processing only</div>';
            }
            
            if (status.lastProcessed) {
              statusHtml += `
                <div style="font-size: 12px; color: #5f6368; margin-top: 8px;">
                  Last processed: ${new Date(status.lastProcessed).toLocaleString()}
                </div>
              `;
            }
            
            container.innerHTML = statusHtml;
          })
          .withFailureHandler(function(error) {
            document.getElementById('processing-status').innerHTML = 
              '<div class="message error">Error loading status: ' + error + '</div>';
          })
          .getProcessingStatus();
      }
      
      // Helper function to get day name from day number
      function getDayName(dayNumber) {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return days[parseInt(dayNumber)] || 'Unknown';
      }
      
      // Update configuration visibility based on frequency selection
      function updateConfigVisibility() {
        const frequency = document.getElementById('frequency-select').value;
        const intervalRow = document.getElementById('interval-row');
        const dayRow = document.getElementById('day-row');
        const timeRow = document.getElementById('time-row');
        
        // Show interval for interval-based frequency
        intervalRow.style.display = frequency === 'interval' ? 'flex' : 'none';
        
        // Show day selector for weekly frequency
        dayRow.style.display = frequency === 'weekly' ? 'flex' : 'none';
        
        // Show time for daily and weekly
        timeRow.style.display = (frequency === 'daily' || frequency === 'weekly') ? 'flex' : 'none';
      }
      
      // Frequency change handler
      document.getElementById('frequency-select').addEventListener('change', updateConfigVisibility);
      
      // Helper function to show messages
      function showMessage(message, type) {
        const msgElement = document.getElementById('status-message');
        msgElement.textContent = message;
        msgElement.className = 'message ' + type;
        msgElement.classList.remove('hidden');
        
        // Hide message after 5 seconds
        setTimeout(function() {
          msgElement.classList.add('hidden');
        }, 5000);
      }
      
      // Test API Connection
      document.getElementById('testApiBtn').addEventListener('click', function() {
        const apiTestResult = document.getElementById('api-test-result');
        const btn = this;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span>Testing...';
        apiTestResult.textContent = 'Testing API connection...';
        apiTestResult.className = 'message info';
        apiTestResult.classList.remove('hidden');
        
        google.script.run
          .withSuccessHandler(function(result) {
            const statusIndicator = document.getElementById('token-status-indicator');
            
            if (result.success) {
              apiTestResult.innerHTML = '<strong>✓ Connection Successful!</strong><br>' + (result.message || 'Access token is valid and working.');
              apiTestResult.className = 'message success';
              statusIndicator.className = 'status-indicator connected';
            } else {
              apiTestResult.innerHTML = '<strong>✗ Connection Failed</strong><br>' + (result.error || 'Unable to connect to API');
              apiTestResult.className = 'message error';
              statusIndicator.className = 'status-indicator disconnected';
            }
            btn.disabled = false;
            btn.innerHTML = 'Test Connection';
          })
          .withFailureHandler(function(error) {
            apiTestResult.innerHTML = '<strong>✗ Test Failed</strong><br>Error: ' + error;
            apiTestResult.className = 'message error';
            document.getElementById('token-status-indicator').className = 'status-indicator disconnected';
            btn.disabled = false;
            btn.innerHTML = 'Test Connection';
          })
          .testApiConnection();
      });
      
      // Save access token - UPDATED to refresh display after saving
      document.getElementById('saveaccessTokenBtn').addEventListener('click', function() {
        const accessToken = document.getElementById('access-token-input').value.trim();
        
        if (!accessToken) {
          showMessage('Please enter a valid access token', 'error');
          return;
        }
        
        this.disabled = true;
        this.innerHTML = '<span class="loading"></span>Saving...';
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Access token saved successfully!', 'success');
              // Clear input and refresh display to show masked token
              document.getElementById('access-token-input').value = '';
              loadSavedAccessToken(); // This will switch to display mode
            } else {
              showMessage(result.error || 'Failed to save access token', 'error');
            }
            document.getElementById('saveaccessTokenBtn').disabled = false;
            document.getElementById('saveaccessTokenBtn').innerHTML = 'Save Access Token';
          })
          .withFailureHandler(function(error) {
            showMessage('Error: ' + error, 'error');
            document.getElementById('saveaccessTokenBtn').disabled = false;
            document.getElementById('saveaccessTokenBtn').innerHTML = 'Save Access Token';
          })
          .saveaccessToken(accessToken);
      });
      
      // Save configuration
      document.getElementById('saveConfigBtn').addEventListener('click', function() {
        const frequency = document.getElementById('frequency-select').value;
        const interval = parseInt(document.getElementById('interval-input').value) || 3;
        const time = document.getElementById('time-input').value || '11:00';
        const day = document.getElementById('day-select').value || '1';
        
        const config = {
          enabled: frequency !== 'manual',
          frequency: frequency,
          interval: interval,
          time: time,
          day: day
        };
        
        this.disabled = true;
        this.innerHTML = '<span class="loading"></span>Saving...';
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Configuration saved successfully!', 'success');
              loadProcessingStatus(); // Refresh status
            } else {
              showMessage(result.error || 'Failed to save configuration', 'error');
            }
            document.getElementById('saveConfigBtn').disabled = false;
            document.getElementById('saveConfigBtn').innerHTML = 'Save Configuration';
          })
          .withFailureHandler(function(error) {
            showMessage('Error: ' + error, 'error');
            document.getElementById('saveConfigBtn').disabled = false;
            document.getElementById('saveConfigBtn').innerHTML = 'Save Configuration';
          })
          .saveBatchConfig(config);
      });
      
      // Process responses
      document.getElementById('processResponsesBtn').addEventListener('click', function() {
        const processResult = document.getElementById('process-result');
        const btn = this;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span>Processing...';
        processResult.textContent = 'Processing all responses...';
        processResult.className = 'message info';
        processResult.classList.remove('hidden');
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              let hashDisplay = '';
              if (result.hash) {
                const shortHash = result.hash.substring(0, 16) + '...';
                hashDisplay = `<br>Hash: <span class="hash-link" onclick="openVerificationPage('${result.hash}')" title="Click to verify on notamperdata.com">${shortHash}</span>`;
              }
              
              processResult.innerHTML = 
                '<strong>✓ Processing Successful!</strong><br>' +
                'Processed: ' + result.processed + ' responses' +
                hashDisplay;
              processResult.className = 'message success';
              loadProcessingStatus(); // Refresh status
            } else {
              processResult.innerHTML = '<strong>✗ Processing Failed</strong><br>' + (result.error || 'Unable to process responses');
              processResult.className = 'message error';
            }
            btn.disabled = false;
            btn.innerHTML = 'Process Responses';
          })
          .withFailureHandler(function(error) {
            processResult.innerHTML = '<strong>✗ Processing Error</strong><br>Error: ' + error;
            processResult.className = 'message error';
            btn.disabled = false;
            btn.innerHTML = 'Process Responses';
          })
          .processFormResponses();
      });
      
      // Function to open verification page with hash
      function openVerificationPage(hash) {
        const verificationUrl = `https://notamperdata.com/verification/${hash}`;
        window.open(verificationUrl, '_blank');
      }
      
      // Disable batch processing
      document.getElementById('disableBtn').addEventListener('click', function() {
        const config = {
          enabled: false,
          frequency: 'manual'
        };
        
        this.disabled = true;
        this.innerHTML = '<span class="loading"></span>Disabling...';
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Batch processing disabled', 'info');
              loadProcessingStatus(); // Refresh status
            } else {
              showMessage(result.error || 'Failed to disable processing', 'error');
            }
            document.getElementById('disableBtn').disabled = false;
            document.getElementById('disableBtn').innerHTML = 'Disable Processing';
          })
          .withFailureHandler(function(error) {
            showMessage('Error: ' + error, 'error');
            document.getElementById('disableBtn').disabled = false;
            document.getElementById('disableBtn').innerHTML = 'Disable Processing';
          })
          .saveBatchConfig(config);
      });
      
    </script>
  </body>
</html>